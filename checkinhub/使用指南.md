# CheckinHub 使用指南

## 📚 目录

1. [快速开始](#快速开始)
2. [配置说明](#配置说明)
3. [运行签到](#运行签到)
4. [查看日志](#查看日志)
5. [设置通知](#设置通知)
6. [定时运行](#定时运行)
7. [常见问题](#常见问题)

## 快速开始

### 自动安装（推荐）

```bash
./quickstart.sh
```

### 手动安装

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 复制配置文件
cp config/config.toml.example config/config.toml
cp config/sites.toml.example config/sites.toml

# 3. 编辑配置
nano config/sites.toml
```

## 配置说明

### 主配置文件 (config/config.toml)

```toml
[logging]
level = "INFO"                    # 日志级别: DEBUG, INFO, WARNING, ERROR
console_output = true             # 是否输出到控制台

[notifications.telegram]
enabled = false                   # 是否启用 Telegram 通知
bot_token = "YOUR_BOT_TOKEN"      # Bot Token
chat_id = "YOUR_CHAT_ID"          # Chat ID

[notifications.dingtalk]
enabled = false                   # 是否启用钉钉通知
webhook = "YOUR_WEBHOOK"          # Webhook 地址
secret = "YOUR_SECRET"            # 加签密钥
```

### 站点配置文件 (config/sites.toml)

每个站点的配置格式：

```toml
[站点ID]
name = "站点名称"
enabled = true              # 是否启用
notify = true               # 是否发送通知

[[站点ID.accounts]]
username = "用户名"
password = "密码"
cookie = "Cookie字符串"
enabled = true              # 该账户是否启用
```

### 示例：配置 GLaDOS

```toml
[glados]
name = "GLaDOS"
enabled = true
notify = true

[[glados.accounts]]
username = "your@email.com"
password = ""
cookie = "koa:sess=你的Cookie"
enabled = true
```

**如何获取 Cookie？**

1. 打开浏览器，登录 GLaDOS
2. 按 F12 打开开发者工具
3. 切换到 "Application" 或 "存储" 标签
4. 左侧选择 "Cookies"
5. 找到 `koa:sess` 的值，复制完整内容

### 示例：配置 HostLoc

```toml
[hostloc]
name = "HostLoc论坛"
enabled = true
notify = true

[[hostloc.accounts]]
username = "your_username"
cookie = "你的Cookie字符串"
uid = "123456"
enabled = true
```

**如何获取 UID？**

登录后访问个人主页，URL 中的数字就是你的 UID：
```
https://hostloc.com/space-uid-123456.html
                              ^^^^^^ 这就是 UID
```

## 运行签到

### 查看所有可用站点

```bash
python main.py --list
```

输出示例：
```
可用站点列表:
============================================================
  [✓] example      - 示例站点                (启用, 2 个账户)
  [✓] glados       - GLaDOS                 (启用, 1 个账户)
  [✗] hostloc      - HostLoc论坛            (禁用, 0 个账户)
============================================================

总计: 3 个站点
```

### 运行所有启用的站点

```bash
python main.py
```

### 运行指定站点

```bash
# 运行单个站点
python main.py glados

# 运行多个站点
python main.py glados hostloc
```

### 指定配置文件

```bash
python main.py --config /path/to/config.toml --sites-config /path/to/sites.toml
```

## 查看日志

### 日志文件位置

```
logs/
├── main.log                    # 主程序日志
├── example_2024-01-15.log     # 示例站点今天的日志
├── glados_2024-01-15.log      # GLaDOS 今天的日志
└── glados_2024-01-14.log      # GLaDOS 昨天的日志
```

### 实时查看日志

```bash
# 查看主日志
tail -f logs/main.log

# 查看特定站点日志（今天）
tail -f logs/glados_$(date +%Y-%m-%d).log
```

### 日志内容示例

```
2024-01-15 08:00:00 - checkinhub.glados - INFO - ==================================================
2024-01-15 08:00:00 - checkinhub.glados - INFO - 开始签到: GLaDOS
2024-01-15 08:00:00 - checkinhub.glados - INFO - ==================================================
2024-01-15 08:00:01 - checkinhub.glados - INFO - 正在签到账户: user@email.com
2024-01-15 08:00:03 - checkinhub.glados - INFO - [user@email.com] 签到成功: 获得 1 天
2024-01-15 08:00:03 - checkinhub.glados - INFO - 签到完成: 成功 1/1
```

## 设置通知

### Telegram 通知

#### 1. 创建 Bot

1. 在 Telegram 中搜索 `@BotFather`
2. 发送 `/newbot` 创建新机器人
3. 按提示设置机器人名称
4. 获得 `bot_token`（类似：`123456789:ABCdefGHIjklMNOpqrsTUVwxyz`）

#### 2. 获取 Chat ID

1. 在 Telegram 中搜索 `@userinfobot`
2. 发送任意消息
3. 获得你的 `chat_id`（纯数字）

#### 3. 配置

编辑 `config/config.toml`：

```toml
[notifications.telegram]
enabled = true
bot_token = "123456789:ABCdefGHIjklMNOpqrsTUVwxyz"
chat_id = "123456789"
```

#### 4. 测试

运行签到后，Telegram 会收到通知消息。

### 钉钉通知

#### 1. 创建群机器人

1. 打开钉钉，进入要接收通知的群
2. 群设置 → 智能群助手 → 添加机器人 → 自定义
3. 设置机器人名称（如：CheckinHub）
4. 安全设置选择"加签"
5. 复制 Webhook 地址和加签密钥

#### 2. 配置

编辑 `config/config.toml`：

```toml
[notifications.dingtalk]
enabled = true
webhook = "https://oapi.dingtalk.com/robot/send?access_token=xxxxx"
secret = "SECxxxxxxxxxxxxxxxxxxxxx"
```

#### 3. 测试

运行签到后，钉钉群会收到通知消息。

### 通知内容示例

```
📊 GLaDOS 签到报告

✅ user1@email.com: 签到成功: 获得 1 天
✅ user2@email.com: 签到成功: 获得 1 天

总计: 成功 2/2
```

## 定时运行

### Linux/Mac - 使用 cron

编辑 crontab：
```bash
crontab -e
```

添加定时任务（每天早上 8 点）：
```bash
0 8 * * * cd /path/to/checkinhub && /usr/bin/python3 main.py >> /path/to/checkinhub/logs/cron.log 2>&1
```

查看 cron 任务：
```bash
crontab -l
```

### Windows - 使用任务计划程序

1. 打开"任务计划程序"
2. 右侧点击"创建基本任务"
3. 名称：CheckinHub 自动签到
4. 触发器：每天
5. 时间：08:00:00
6. 操作：启动程序
   - 程序：`C:\Python3\python.exe`
   - 参数：`main.py`
   - 起始于：`C:\path\to\checkinhub`
7. 完成创建

### Docker - 使用 cron

编辑 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  checkinhub:
    build: .
    container_name: checkinhub
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs
    environment:
      - TZ=Asia/Shanghai
      - CRON_SCHEDULE=0 8 * * *
    restart: unless-stopped
```

### 验证定时任务

添加定时任务后，可以：

1. 等待下次运行时间
2. 查看日志文件确认执行
3. 检查通知是否收到

## 常见问题

### 1. 签到失败：Cookie 过期

**现象**：
```
[user@email.com] 签到失败: HTTP 401
```

**解决**：
1. 重新登录站点
2. 获取新的 Cookie
3. 更新 `config/sites.toml`

### 2. 通知没有收到

**检查**：
1. 配置文件中 `enabled = true`
2. Token/Webhook 配置正确
3. 查看日志是否有错误
4. 站点配置中 `notify = true`

### 3. 导入模块错误

**错误**：
```
ModuleNotFoundError: No module named 'aiohttp'
```

**解决**：
```bash
pip install -r requirements.txt
```

### 4. 配置文件格式错误

**错误**：
```
toml.decoder.TomlDecodeError
```

**解决**：
1. 检查 TOML 语法
2. 确保引号配对
3. 使用在线 TOML 验证器

### 5. 权限错误（Linux/Mac）

**错误**：
```
Permission denied
```

**解决**：
```bash
chmod +x main.py
chmod +x quickstart.sh
```

### 6. 时区不正确

**解决**：

编辑配置文件或设置环境变量：
```bash
export TZ=Asia/Shanghai
python main.py
```

### 7. 日志文件太多

**清理旧日志**：
```bash
# 删除 7 天前的日志
find logs/ -name "*.log" -mtime +7 -delete
```

**自动清理（添加到 crontab）**：
```bash
0 0 * * 0 find /path/to/checkinhub/logs/ -name "*.log" -mtime +30 -delete
```

## 高级技巧

### 1. 批量添加账户

直接编辑 `config/sites.toml`：

```toml
[glados]
name = "GLaDOS"
enabled = true
notify = true

[[glados.accounts]]
username = "user1@email.com"
cookie = "cookie1"
enabled = true

[[glados.accounts]]
username = "user2@email.com"
cookie = "cookie2"
enabled = true

[[glados.accounts]]
username = "user3@email.com"
cookie = "cookie3"
enabled = true
```

### 2. 分组运行

创建不同的配置文件：

```bash
# 运行 VIP 站点
python main.py --sites-config config/sites-vip.toml

# 运行测试站点
python main.py --sites-config config/sites-test.toml
```

### 3. 只发送失败通知

修改 `main.py` 中的通知逻辑：

```python
# 只在有失败时通知
if should_notify and results:
    failed_count = sum(1 for r in results if not r.success)
    if failed_count > 0:
        message = site.format_results_message(results, accounts)
        # 发送通知...
```

### 4. 自定义日志格式

编辑 `config/config.toml`：

```toml
[logging]
level = "INFO"
format = "[%(levelname)s] %(asctime)s - %(message)s"
```

## 更新日志

查看 GitHub Releases 获取最新版本和更新说明。

## 获取帮助

- 查看文档：[README.md](README.md)
- 开发指南：[DEVELOP.md](DEVELOP.md)
- 提交 Issue：GitHub Issues
- 加入讨论：GitHub Discussions

## 免责声明

本工具仅供学习交流使用，请遵守各站点的服务条款。使用本工具所产生的任何后果由使用者自行承担。
